# Prompt Context 작동 방식

## 개요

Prompt Context는 AI 에이전트가 대화 컨텍스트를 효율적으로 관리할 수 있도록 설계된 지능형 MCP 구현입니다. 이 문서는 시스템의 핵심 아키텍처, 구성 요소 및 기술적 결정 사항을 설명합니다.

## 핵심 구성 요소

### 컨텍스트 서비스

컨텍스트 서비스는 구현의 핵심으로 다음과 같은 역할을 담당합니다:

- 메시지 저장 및 검색 관리
- 임계값에 도달하면 자동 요약 트리거
- 다른 구성 요소 간 조정
- 중요도 기반 유지 정책 적용
- 컨텍스트 간 관계 추적 처리

컨텍스트 서비스는 무상태(stateless) 설계를 구현하여 분산 환경에 적합하며 모든 상태는 저장소 레이어에 유지됩니다.

### 저장소 시스템

저장소 레이어는 다음을 통해 영구 저장소를 제공합니다:

- **파일 시스템 저장소**: JSON 형식으로 원시 컨텍스트 데이터와 메타데이터 저장
- **벡터 저장소**: 의미론적 검색 기능을 위한 벡터 임베딩 관리
- **그래프 저장소**: 서로 다른 컨텍스트 간의 관계 추적

이러한 저장소들은 함께 작동하여 대화 기록과 서로 다른 주제 간의 관계에 대한 완전한 그림을 만듭니다. 모든 저장소는 임베디드 디자인 패턴을 구현하여 외부 데이터베이스 서비스의 필요성을 제거합니다.

### 도구 구현

MCP 서버는 AI 에이전트가 사용할 수 있는 여러 도구를 제공합니다:

- **컨텍스트 관리**: `add_message`, `retrieve_context`, `summarize_context`
- **관계 도구**: `add_relationship`, `get_related_contexts`
- **탐색 도구**: `get_similar_contexts`, `visualize_context`
- **분석 도구**: `get_context_metrics`

각 도구는 컨텍스트 서비스와 저장소의 특정 기능에 매핑됩니다.

## 주요 기능

### 자동 요약

컨텍스트가 구성 가능한 임계값(기본값: 10개 메시지)에 도달하면:

1. 요약 프로세스가 트리거됩니다
2. 태그와 중요도 수준에 따라 중요 메시지가 식별됩니다
3. 요약이 생성되어 컨텍스트와 함께 저장됩니다
4. 이 요약은 향후 검색에 사용 가능해집니다

요약 기능은 대화가 길어질수록 중요한 컨텍스트가 손실되지 않도록 합니다. 시스템은 명시적 중요도 플래그와 휴리스틱 분석을 기반으로 요약에서 중요 정보의 우선순위를 지정합니다.

### 벡터 유사도 검색

의미론적 검색 기능은 다음과 같이 작동합니다:

1. 텍스트를 수치 벡터 표현(임베딩)으로 변환
2. HNSW를 사용하여 효율적인 검색을 위해 이러한 임베딩 인덱싱
3. 쿼리와 저장된 컨텍스트 간의 유사도 점수 계산
4. 의미론적 의미에 기반한 가장 관련성 높은 컨텍스트 반환

시스템은 효율적인 근사 최근접 이웃 검색을 위해 계층적 탐색 가능한 작은 세계(HNSW) 알고리즘을 사용하여 준선형 검색 시간 복잡성을 제공합니다.

### 그래프 관계

관계 추적 시스템:

1. 컨텍스트 간 명시적 관계(유사, 참조, 계속, 부모/자식) 저장
2. 관련 컨텍스트 간 탐색 가능
3. 대화 기록의 지식 그래프 구축
4. 양방향 연결 순회 지원

관계 가중치는 검색 결과에 영향을 미쳐 의미적 유사성과 명시적 관계 모두에 기반하여 가장 관련성 높은 컨텍스트를 표출하도록 돕습니다.

## 기술적 구현

### 임베디드 데이터베이스 전략

시스템은 외부 서비스가 필요 없는 완전히 임베디드된 데이터베이스를 사용합니다:

- **벡터 저장소**: 메모리 내 인덱싱과 파일 기반 지속성을 갖춘 HNSW 알고리즘을 사용하여 구현
- **그래프 데이터베이스**: 파일 기반 JSON 저장과 함께 관계 관리를 위한 graphology 라이브러리 사용

이 접근 방식은 다음을 보장합니다:
- Node.js 런타임 외에 외부 종속성 없음
- 복잡한 설정 없이 간단한 배포
- 환경 간 이동성
- MCP 서버 요구 사항과의 호환성

### 모델 로딩 및 임베딩 생성

텍스트 임베딩은 트랜스포머 모델을 사용하여 생성됩니다:

1. 효율적인 추론을 위해 ONNX 모델 사용
2. 지연 로딩으로 필요할 때만 모델 로드
3. 임베딩 캐시로 중복 계산 감소
4. 폴백 메커니즘으로 모델을 사용할 수 없을 때도 시스템 작동 보장

### 성능 고려 사항

여러 최적화 기술로 우수한 성능 보장:

- 논블로킹 작업을 위한 비동기 처리
- 자주 액세스하는 데이터를 위한 지능형 캐싱
- 가능한 경우 효율성을 위한 배치 처리
- 전체 컨텍스트 재처리를 방지하기 위한 증분 업데이트
- 저장소 증가를 관리하기 위한 구성 가능한 정리 정책

## 구성

시스템은 다양한 방법(CLI 인수, 환경 변수, 구성 파일)을 통해 구성할 수 있으며 합리적인 기본값을 제공합니다. 자세한 구성 옵션은 [README](../README.md)를 참조하세요.

## 보안

시스템은 보안 고려 사항을 염두에 두고 설계되었습니다:

- 기본적으로 외부 네트워크 호출이 없음
- 데이터는 지정된 디렉토리 내에 로컬로 저장됨
- 인증 데이터가 일반 텍스트로 저장되지 않음
- 적절한 구성으로 저장 시 컨텍스트 데이터 암호화 가능

## 배포 옵션

Prompt Context는 다양한 배포 시나리오를 지원합니다:

1. **MCP 서버로**: MCP 클라이언트와 함께 사용하기 위한 기본 배포 모드
2. **독립 서비스로**: HTTP 서버로 실행
3. **Docker 컨테이너로**: 컨테이너화된 환경용
4. **라이브러리로**: 다른 Node.js 애플리케이션 내에 임베드

특정 지침은 [README](../README.md)의 설치 및 배포 섹션을 참조하세요.
